# ═══════════════════════════════════════════════════════════════════════════════
# RPlus Server — Build & Deploy Individual Services
# ═══════════════════════════════════════════════════════════════════════════════
#
# Triggers:
#   - Push to master (auto-detects changed services)
#   - Manual dispatch (pick specific services)
#
# Flow: Build → Push to GHCR → SSH deploy to k3s
# ═══════════════════════════════════════════════════════════════════════════════

name: Deploy Services

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      services:
        description: 'Comma-separated service names (e.g. "auth,hunter,gateway") or "all"'
        required: true
        default: 'all'
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/rplus

# ─── Permissions ──────────────────────────────────────────────────────────────
permissions:
  contents: read
  packages: write

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # 1. Detect which services changed (or use manual input)
  # ═══════════════════════════════════════════════════════════════════════════
  detect:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_services: ${{ steps.set-matrix.outputs.has_services }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed services
        id: set-matrix
        run: |
          # ── Service registry: name → dockerfile path (relative to repo root)
          declare -A SERVICES=(
            ["access"]="src/RPlus.Kernel.Access/Dockerfile"
            ["audit"]="src/RPlus.Kernel.Audit/Dockerfile"
            ["auth"]="src/RPlus.Kernel.Auth/Dockerfile"
            ["documents"]="src/RPlus.Kernel.Documents/Dockerfile"
            ["gateway"]="src/RPlus.Kernel.Gateway/Dockerfile"
            ["guard"]="src/RPlus.Kernel.Guard/Dockerfile"
            ["hr"]="src/RPlus.Kernel.HR/Dockerfile"
            ["hunter"]="src/RPlus.Kernel.Hunter/Dockerfile"
            ["integration"]="src/RPlus.Kernel.Integration/Dockerfile"
            ["loyalty"]="src/RPlus.Kernel.Loyalty/Dockerfile"
            ["meta"]="src/RPlus.Kernel.Meta/Dockerfile"
            ["organization"]="src/RPlus.Kernel.Organization/Dockerfile"
            ["runtime"]="src/RPlus.Kernel.Runtime/Dockerfile"
            ["users"]="src/RPlus.Kernel.Users/Dockerfile"
            ["wallet"]="src/RPlus.Kernel.Wallet/Dockerfile"
            ["walletadapter"]="src/RPlus.WalletAdapter/Dockerfile"
          )

          SELECTED=()

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            INPUT="${{ inputs.services }}"
            if [[ "$INPUT" == "all" ]]; then
              SELECTED=("${!SERVICES[@]}")
            else
              IFS=',' read -ra SELECTED <<< "$INPUT"
            fi
          else
            # Auto-detect from changed files
            CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")

            for svc in "${!SERVICES[@]}"; do
              DIR="src/RPlus.Kernel.${svc^}"
              # Also rebuild if SDK or shared code changed
              if echo "$CHANGED" | grep -qiE "(${DIR}|RPlus\.SDK|RPlusGrpc|Directory\.(Packages|Build)\.props|LocalPackages)"; then
                SELECTED+=("$svc")
              fi
            done

            # Special case: if shared deps changed, rebuild everything
            if echo "$CHANGED" | grep -qiE "^(RPlus\.SDK|RPlusGrpc|Directory\.(Packages|Build)\.props|LocalPackages)"; then
              SELECTED=("${!SERVICES[@]}")
            fi
          fi

          # Build JSON matrix
          if [[ ${#SELECTED[@]} -eq 0 ]]; then
            echo "matrix={\"include\":[]}" >> "$GITHUB_OUTPUT"
            echo "has_services=false" >> "$GITHUB_OUTPUT"
            echo "No services to build"
          else
            JSON="["
            FIRST=true
            for svc in "${SELECTED[@]}"; do
              svc=$(echo "$svc" | tr -d ' ')
              DF="${SERVICES[$svc]}"
              if [[ -n "$DF" ]]; then
                if [[ "$FIRST" == true ]]; then FIRST=false; else JSON+=","; fi
                JSON+="{\"service\":\"$svc\",\"dockerfile\":\"$DF\"}"
              fi
            done
            JSON+="]"
            echo "matrix={\"include\":$JSON}" >> "$GITHUB_OUTPUT"
            echo "has_services=true" >> "$GITHUB_OUTPUT"
            echo "Building: ${SELECTED[*]}"
          fi

  # ═══════════════════════════════════════════════════════════════════════════
  # 2. Build & Push Docker images to GHCR
  # ═══════════════════════════════════════════════════════════════════════════
  build:
    needs: detect
    if: needs.detect.outputs.has_services == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate tags
        id: tags
        run: |
          TAG="v$(date +%Y%m%d-%H%M%S)"
          IMAGE="${IMAGE_PREFIX}-${{ matrix.service }}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"
          echo "Building ${IMAGE}:${TAG}"

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: true
          tags: |
            ${{ steps.tags.outputs.image }}:${{ steps.tags.outputs.tag }}
            ${{ steps.tags.outputs.image }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ═══════════════════════════════════════════════════════════════════════════
  # 3. Deploy to k3s server via SSH
  # ═══════════════════════════════════════════════════════════════════════════
  deploy:
    needs: [detect, build]
    if: needs.detect.outputs.has_services == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Deploy ${{ matrix.service }} to k3s
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            IMAGE="${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:latest"
            DEPLOYMENT="rplus-kernel-${{ matrix.service }}"
            NAMESPACE="rplus"

            echo "=== Deploying ${DEPLOYMENT} ==="

            # Pull latest image
            k3s ctr images pull --user "${{ secrets.GHCR_USER }}:${{ secrets.GHCR_TOKEN }}" "${IMAGE}" || true

            # Update deployment image (creates if k8s manifests applied)
            k3s kubectl set image deployment/${DEPLOYMENT} \
              ${DEPLOYMENT}=${IMAGE} \
              -n ${NAMESPACE} 2>/dev/null || echo "Deployment not found, skipping kubectl set image"

            # Restart to force pull
            k3s kubectl rollout restart deployment/${DEPLOYMENT} -n ${NAMESPACE} 2>/dev/null || true

            # Wait for rollout
            k3s kubectl rollout status deployment/${DEPLOYMENT} \
              -n ${NAMESPACE} --timeout=120s 2>/dev/null || echo "Rollout status check skipped"

            echo "=== ${DEPLOYMENT} deployed ==="
