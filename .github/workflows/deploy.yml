# ═══════════════════════════════════════════════════════════════════════════════
# RPlus Server — Build & Deploy Individual Services
# ═══════════════════════════════════════════════════════════════════════════════
#
# Triggers:
#   - Push to master (auto-detects changed services)
#   - Manual dispatch (pick specific services)
#
# Uses SELF-HOSTED runner on the production server.
# Build → docker load into k3s → kubectl rollout restart
# ═══════════════════════════════════════════════════════════════════════════════

name: Deploy Services

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      services:
        description: 'Comma-separated service names (e.g. "auth,hunter,gateway") or "all"'
        required: true
        default: 'all'
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/rplus

# ─── Permissions ──────────────────────────────────────────────────────────────
permissions:
  contents: read
  packages: write

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # 1. Detect which services changed (or use manual input)
  # ═══════════════════════════════════════════════════════════════════════════
  detect:
    runs-on: self-hosted
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_services: ${{ steps.set-matrix.outputs.has_services }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed services
        id: set-matrix
        run: |
          # ── Service registry: name → dockerfile path (relative to repo root)
          declare -A SERVICES=(
            ["access"]="src/RPlus.Kernel.Access/Dockerfile"
            ["audit"]="src/RPlus.Kernel.Audit/Dockerfile"
            ["auth"]="src/RPlus.Kernel.Auth/Dockerfile"
            ["documents"]="src/RPlus.Kernel.Documents/Dockerfile"
            ["gateway"]="src/RPlus.Kernel.Gateway/Dockerfile"
            ["guard"]="src/RPlus.Kernel.Guard/Dockerfile"
            ["hr"]="src/RPlus.Kernel.HR/Dockerfile"
            ["hunter"]="src/RPlus.Kernel.Hunter/Dockerfile"
            ["integration"]="src/RPlus.Kernel.Integration/Dockerfile"
            ["loyalty"]="src/RPlus.Kernel.Loyalty/Dockerfile"
            ["meta"]="src/RPlus.Kernel.Meta/Dockerfile"
            ["organization"]="src/RPlus.Kernel.Organization/Dockerfile"
            ["runtime"]="src/RPlus.Kernel.Runtime/Dockerfile"
            ["users"]="src/RPlus.Kernel.Users/Dockerfile"
            ["wallet"]="src/RPlus.Kernel.Wallet/Dockerfile"
            ["walletadapter"]="src/RPlus.WalletAdapter/Dockerfile"
          )

          SELECTED=()

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            INPUT="${{ inputs.services }}"
            if [[ "$INPUT" == "all" ]]; then
              SELECTED=("${!SERVICES[@]}")
            else
              IFS=',' read -ra SELECTED <<< "$INPUT"
            fi
          else
            # Auto-detect from changed files
            CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")

            for svc in "${!SERVICES[@]}"; do
              # Match service directory (case-insensitive for the first letter)
              DIR="src/RPlus.Kernel.${svc^}"
              if echo "$CHANGED" | grep -qiE "^${DIR}/"; then
                SELECTED+=("$svc")
              fi
            done

            # Special case: WalletAdapter
            if echo "$CHANGED" | grep -qi "^src/RPlus.WalletAdapter/"; then
              SELECTED+=("walletadapter")
            fi

            # Shared deps changed → rebuild everything
            if echo "$CHANGED" | grep -qiE "^(RPlus\.SDK/|RPlusGrpc/|Directory\.(Packages|Build)\.props|LocalPackages/)"; then
              SELECTED=("${!SERVICES[@]}")
            fi
          fi

          # Build JSON matrix
          if [[ ${#SELECTED[@]} -eq 0 ]]; then
            echo "matrix={\"include\":[]}" >> "$GITHUB_OUTPUT"
            echo "has_services=false" >> "$GITHUB_OUTPUT"
            echo "No services to build"
          else
            JSON="["
            FIRST=true
            for svc in "${SELECTED[@]}"; do
              svc=$(echo "$svc" | tr -d ' ')
              DF="${SERVICES[$svc]}"
              if [[ -n "$DF" ]]; then
                if [[ "$FIRST" == true ]]; then FIRST=false; else JSON+=","; fi
                JSON+="{\"service\":\"$svc\",\"dockerfile\":\"$DF\"}"
              fi
            done
            JSON+="]"
            echo "matrix={\"include\":$JSON}" >> "$GITHUB_OUTPUT"
            echo "has_services=true" >> "$GITHUB_OUTPUT"
            echo "Building: ${SELECTED[*]}"
          fi

  # ═══════════════════════════════════════════════════════════════════════════
  # 2. Build Docker images & deploy to k3s (on the same server)
  # ═══════════════════════════════════════════════════════════════════════════
  build-and-deploy:
    needs: detect
    if: needs.detect.outputs.has_services == 'true'
    runs-on: self-hosted
    strategy:
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: |
          TAG="v$(date +%Y%m%d-%H%M%S)"
          IMAGE="rplus-${{ matrix.service }}"
          echo "Building ${IMAGE}:${TAG}..."

          docker build \
            -f ${{ matrix.dockerfile }} \
            -t ${IMAGE}:${TAG} \
            -t ${IMAGE}:latest \
            .

          echo "image=${IMAGE}" >> "$GITHUB_ENV"
          echo "tag=${TAG}" >> "$GITHUB_ENV"

      - name: Import image into k3s
        run: |
          # Save & import into k3s containerd
          docker save ${image}:latest | k3s ctr images import -
        env:
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml

      - name: Deploy to k3s
        run: |
          DEPLOYMENT="rplus-kernel-${{ matrix.service }}"
          NAMESPACE="rplus"

          echo "=== Deploying ${DEPLOYMENT} ==="

          # Update deployment image
          k3s kubectl set image deployment/${DEPLOYMENT} \
            ${DEPLOYMENT}=${image}:latest \
            -n ${NAMESPACE} 2>/dev/null && \
          k3s kubectl rollout restart deployment/${DEPLOYMENT} -n ${NAMESPACE} && \
          k3s kubectl rollout status deployment/${DEPLOYMENT} \
            -n ${NAMESPACE} --timeout=120s || \
          echo "Note: Deployment ${DEPLOYMENT} not found in k3s yet (apply manifests first)"

          echo "=== ${DEPLOYMENT} done ==="
        env:
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
