syntax = "proto3";

package rplus.loyalty.ai;

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "loyalty.engine.proto";

option go_package = "rplus/loyalty/ai;ai";
option csharp_namespace = "RPlusGrpc.Loyalty.AI";
option java_multiple_files = true;
option java_package = "com.rplus.loyalty.ai";
option java_outer_classname = "LoyaltyAIAssistantProto";

// =========================
// AI Assistant Service
// =========================

service LoyaltyAIAssistantService {

  // Generate a new rule from natural language description
  rpc GenerateRule(GenerateRuleRequest) returns (GenerateRuleResponse);

  // Analyze an existing rule for problems and improvements
  rpc AnalyzeRule(AnalyzeRuleRequest) returns (AnalyzeRuleResponse);

  // Improve / refactor an existing rule (no auto-apply)
  rpc ImproveRule(ImproveRuleRequest) returns (ImproveRuleResponse);

  // Explain rule logic in human-readable form
  rpc ExplainRule(ExplainRuleRequest) returns (ExplainRuleResponse);

  // Validate rule via Engine (ValidateRule)
  rpc ValidateRule(ValidateRuleRequest) returns (ValidateRuleResponse);

  // Simulate rule via Engine (ExecuteAdHoc)
  rpc SimulateRule(SimulateRuleRequest) returns (SimulateRuleResponse);
}

// =========================
// Generate Rule
// =========================

message GenerateRuleRequest {
  string description = 1; // Natural language description
  repeated string allowed_conditions = 2;
  repeated string allowed_actions = 3;
  google.protobuf.Struct constraints = 4; // business / partner / environment limits
  string correlation_id = 5;
}

message GenerateRuleResponse {
  bool success = 1;
  rplus.loyalty.engine.RuleDefinition rule = 2;
  repeated string warnings = 3;
  string error_message = 4;
}

// =========================
// Analyze Rule
// =========================

message AnalyzeRuleRequest {
  rplus.loyalty.engine.RuleDefinition rule = 1;
}

message AnalyzeRuleResponse {
  bool valid = 1;
  repeated RuleIssue errors = 2;
  repeated RuleIssue warnings = 3;
  repeated RuleSuggestion suggestions = 4;
}

message RuleIssue {
  string code = 1;
  string message = 2;
  string path = 3; // e.g. conditions[2], actions[0]
}

message RuleSuggestion {
  string code = 1;
  string message = 2;
  google.protobuf.Struct proposed_change = 3;
}

// =========================
// Improve Rule
// =========================

message ImproveRuleRequest {
  rplus.loyalty.engine.RuleDefinition rule = 1;
  repeated string goals = 2; // e.g. "simplify", "optimize", "readability"
}

message ImproveRuleResponse {
  bool success = 1;
  rplus.loyalty.engine.RuleDefinition improved_rule = 2;
  repeated RuleSuggestion applied_suggestions = 3;
  string error_message = 4;
}

// =========================
// Explain Rule
// =========================

message ExplainRuleRequest {
  rplus.loyalty.engine.RuleDefinition rule = 1;
  ExplainFormat format = 2;
}

message ExplainRuleResponse {
  string explanation = 1;
  repeated string steps = 2;
}

enum ExplainFormat {
  EXPLAIN_FORMAT_UNSPECIFIED = 0;
  SHORT = 1;
  DETAILED = 2;
  STEP_BY_STEP = 3;
}

// =========================
// Validate Rule (Engine proxy)
// =========================

message ValidateRuleRequest {
  rplus.loyalty.engine.RuleDefinition rule = 1;
}

message ValidateRuleResponse {
  bool valid = 1;
  repeated string errors = 2;
  google.protobuf.Struct engine_summary = 3;
}

// =========================
// Simulate Rule (Engine proxy)
// =========================

message SimulateRuleRequest {
  rplus.loyalty.engine.RuleDefinition rule = 1;
  google.protobuf.Struct context = 2;
  string correlation_id = 3;
}

message SimulateRuleResponse {
  bool success = 1;
  rplus.loyalty.engine.ExecutionResult result = 2;
  repeated rplus.loyalty.engine.ActionResult actions = 3;
  string error_message = 4;
}
